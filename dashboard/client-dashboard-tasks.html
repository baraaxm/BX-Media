<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BX Media - Client Tasks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>

<body>

<div class="shell shell-multi client-shell">
  <input type="checkbox" id="sidebarToggle" class="sidebar-toggle" />

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <img src="../assets/index/7 logo.png" alt="BX Media" />
      <span>BX Media</span>
    </div>

    <div class="sidebar-section-title">Main</div>
    <nav class="nav nav-main">
      <a href="client-dashboard-overview.html" id="navOverview"><i class="fas fa-grid-2"></i> Dashboard</a>
      <a href="client-dashboard-projects.html" id="navProjectsLink"><i class="fas fa-diagram-project"></i> My Projects</a>
      <a href="client-dashboard-tasks.html" id="navTasksLink"><i class="fas fa-list-check"></i> My Tasks</a>
      <a href="client-dashboard-deliverables.html" id="navDeliverablesLink"><i class="fas fa-box-open"></i> Deliverables</a>
    </nav>

    <div class="sidebar-section-title">Account</div>
    <nav class="nav nav-account">
      <button id="logoutBtn"><i class="fas fa-arrow-right-from-bracket"></i> Log out</button>
    </nav>

    <div class="sidebar-section-title stats-title">Overview</div>
    <div class="sidebar-stats-grid">
      <div class="stat-card"><span>Total projects</span><strong id="statTotalProjects">&mdash;</strong></div>
      <div class="stat-card"><span>Total tasks</span><strong id="statTotalTasks">&mdash;</strong></div>
      <div class="stat-card"><span>In progress</span><strong id="statInProgress">&mdash;</strong></div>
      <div class="stat-card"><span>Completed</span><strong id="statCompleted">&mdash;</strong></div>
      <div class="stat-card"><span>Not started</span><strong id="statNotStarted">&mdash;</strong></div>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <div class="page-container">
      <section class="panel">
        <header class="panel-header">
          <div class="header-title-row">
            <label for="sidebarToggle" class="sidebar-toggle-btn" aria-label="Open navigation">
              <i class="fas fa-bars"></i>
            </label>
            <div>
              <h1>My Tasks</h1>
              <p class="panel-subtitle">Read-only updates managed by BX Media.</p>
            </div>
          </div>
          <div class="header-meta">
            <div class="client-meta">
              <span class="client-name" id="headerClientName">Client</span>
              <span class="status-badge" id="headerClientStatus">Active</span>
            </div>
          </div>
        </header>

        <p class="managed-note">Tasks are managed by BX Media. This view is read-only.</p>
        <div class="subpanel section-block">
          <div class="tasks-filters">
            <div class="form-row">
              <label>Project</label>
              <select id="projectFilterSelect"></select>
            </div>
            <div class="form-row">
              <label>Assignee</label>
              <select id="assigneeFilterSelect">
                <option value="all">All</option>
                <option value="bx-media">BX Media</option>
                <option value="client">Client</option>
              </select>
            </div>
          </div>
        </div>

        <div id="projectViewHeader"></div>

        <div id="projectTabs"></div>

        <div id="projectTabViews">
          <section id="projectOverviewSection" class="subpanel section-block" style="display:none"></section>
          <section id="projectTasksSection" class="subpanel section-block">
            <h2>Tasks</h2>
            <div id="tasksTableWrapper"></div>
          </section>
          <section id="projectFilesSection" class="subpanel section-block" style="display:none">
            <h2>Files</h2>
            <div id="filesGrid" class="deliverables-grid"></div>
          </section>
        </div>
      </section>
    </div>
  </main>

</div>

<div class="modal" id="filesLinksModal" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-backdrop" data-modal-close></div>
  <div class="modal-panel">
    <header class="modal-header">
      <div>
        <h2 id="filesLinksTitle">Deliverable links</h2>
        <p class="modal-helper" id="filesLinksSubtitle"></p>
      </div>
      <button class="ghost modal-close" type="button" data-modal-close>
        <i class="fas fa-xmark"></i> Close
      </button>
    </header>
    <div class="modal-body">
      <div class="modal-links" id="filesLinksList"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-client.js"></script>
<script src="js/dashboard-core.js"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const sess = BXCore.requireAuth(); // client allowed
  if (!sess) return;

  const wrapper = document.getElementById("tasksTableWrapper");
  const headerEl = document.getElementById("projectViewHeader");
  const tabsEl = document.getElementById("projectTabs");
  const overviewSection = document.getElementById("projectOverviewSection");
  const tasksSection = document.getElementById("projectTasksSection");
  const filesSection = document.getElementById("projectFilesSection");
  const filesGrid = document.getElementById("filesGrid");
  const projectFilterSelect = document.getElementById("projectFilterSelect");
  const filesLinksModal = document.getElementById("filesLinksModal");
  const filesLinksTitle = document.getElementById("filesLinksTitle");
  const filesLinksSubtitle = document.getElementById("filesLinksSubtitle");
  const filesLinksList = document.getElementById("filesLinksList");
  const assigneeFilterSelect = document.getElementById("assigneeFilterSelect");
  BXCore.renderSkeleton(wrapper, "timeline", 4);

  // Load all data
  let data;
  try {
    data = await BXCore.apiGetAll();
    BXCore.updateSidebarStats(data);
    BXCore.renderClientHeader(data.clients || []);
  } catch (err) {
    console.error(err);
    wrapper.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon"><i class="fas fa-circle-exclamation"></i></div>
        <div>
          <h3>We could not load tasks</h3>
          <p>Something went wrong while loading your updates.</p>
          <p class="empty-hint">Next step: refresh the page or try again later.</p>
        </div>
      </div>
    `;
    return;
  }

  const projects = data.projects || [];
  const tasks = data.tasks || [];
  const deliverables = data.deliverables || [];

  const params = new URLSearchParams(window.location.search);
  const selectedProjectId = params.get("projectId");
  const visibleProjects = selectedProjectId
    ? projects.filter((p) => p.projectId === selectedProjectId)
    : projects.slice();

  if (!visibleProjects.length) {
    wrapper.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon"><i class="fas fa-magnifying-glass"></i></div>
        <div>
          <h3>We could not find that project</h3>
          <p>Return to My Projects to choose another project.</p>
          <p class="empty-hint">Next step: open a different project to view tasks.</p>
        </div>
      </div>
    `;
    return;
  }

  const selectedProject = selectedProjectId
    ? visibleProjects.find((p) => p.projectId === selectedProjectId)
    : null;

  const populateProjectFilter = () => {
    if (!projectFilterSelect) return;
    projectFilterSelect.innerHTML = "";
    const allOpt = document.createElement("option");
    allOpt.value = "all";
    allOpt.textContent = "All projects";
    projectFilterSelect.appendChild(allOpt);
    visibleProjects.forEach((p) => {
      const opt = document.createElement("option");
      opt.value = p.projectId;
      opt.textContent = p.name || p.projectId;
      projectFilterSelect.appendChild(opt);
    });
    if (selectedProjectId) {
      projectFilterSelect.value = selectedProjectId;
    }
  };

  const isVisibleDeliverable = (d) => {
    if (d?.visibleToClient === undefined || d?.visibleToClient === null) return true;
    if (typeof d.visibleToClient === "string") return d.visibleToClient.toLowerCase() === "true";
    return d.visibleToClient === true;
  };

  const setActiveTab = (tabId) => {
    const tabButtons = tabsEl?.querySelectorAll("[data-tab]") || [];
    tabButtons.forEach((btn) => {
      btn.classList.toggle("is-active", btn.dataset.tab === tabId);
    });
    if (overviewSection) overviewSection.style.display = tabId === "overview" ? "block" : "none";
    if (tasksSection) tasksSection.style.display = tabId === "tasks" ? "block" : "none";
    if (filesSection) filesSection.style.display = tabId === "files" ? "block" : "none";
  };

  if (selectedProject) {
    const projectTasks = tasks.filter((t) => t.projectId === selectedProject.projectId);
    const projectDeliverables = deliverables.filter(
      (d) => d.projectId === selectedProject.projectId && isVisibleDeliverable(d)
    );
    const progress = BXCore.computeProjectProgress(projectTasks);
    const progressLabel = progress === 0 ? "--" : `${progress}%`;
    const progressHelper = progress === 0 ? "No tasks yet" : "";
    headerEl.innerHTML = `
      <section class="subpanel">
        <div class="project-view-head">
          <div>
            <h2>${selectedProject.name || "Project"}</h2>
            <p class="project-meta-line">Managed by BX Media</p>
          </div>
          <span class="badge ${selectedProject.status || "in-progress"}">
            ${(selectedProject.status || "in-progress").replace("-", " ")}
          </span>
        </div>
        <div class="project-progress">
          <span class="progress-value">${progressLabel}</span>
          <progress max="100" value="${progress}"></progress>
          ${progressHelper ? `<span class="progress-helper">${progressHelper}</span>` : ""}
        </div>
      </section>
    `;

    tabsEl.innerHTML = `
      <div class="tabs">
        <button class="tab is-active" type="button" data-tab="overview">Overview</button>
        <button class="tab" type="button" data-tab="tasks">Tasks</button>
        <button class="tab" type="button" data-tab="files">Files</button>
      </div>
    `;
    if (overviewSection) {
      overviewSection.innerHTML = `
        <h2>Overview</h2>
        <p class="helper">${selectedProject.description || "No description added yet."}</p>
        <div class="summary-row" style="margin-top:1rem;">
          <div class="summary-card neutral">
            <span class="summary-icon"><i class="fas fa-list-check"></i></span>
            <div>
              <span>Tasks</span>
              <strong>${projectTasks.length}</strong>
              <span class="summary-helper">Linked to this project</span>
            </div>
          </div>
          <div class="summary-card neutral">
            <span class="summary-icon"><i class="fas fa-box-open"></i></span>
            <div>
              <span>Files</span>
              <strong>${projectDeliverables.length}</strong>
              <span class="summary-helper">Deliverables available</span>
            </div>
          </div>
        </div>
      `;
    }
    if (filesGrid) {
      filesGrid.innerHTML = "";
      if (!projectDeliverables.length) {
        filesGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-box-open"></i></div>
            <div>
              <h3>No files yet</h3>
              <p>Your BX Media team will add deliverables here when ready.</p>
              <p class="empty-hint">Next step: check back after delivery.</p>
            </div>
          </div>
        `;
      } else {
        projectDeliverables.forEach((d) => {
          const statusValue = d.status || "not-started";
          const hasLinks = Boolean(
            d.deliveryLink || d.downloadLink || d.previewLink || d.driveLink
          );
          const card = document.createElement("article");
          card.className = "deliverable-card";
          card.dataset.title = d.name || "Deliverable";
          card.dataset.subtitle = selectedProject?.name || "Project";
          if (d.deliveryLink) card.dataset.deliveryLink = d.deliveryLink;
          if (d.downloadLink) card.dataset.downloadLink = d.downloadLink;
          if (d.previewLink) card.dataset.previewLink = d.previewLink;
          if (d.driveLink) card.dataset.driveLink = d.driveLink;
          card.innerHTML = `
            <div class="deliverable-cover" style="${
              d.coverImage ? `background-image:url('${d.coverImage}')` : ""
            }">
              <span class="badge ${statusValue}">${statusValue.replace("-", " ")}</span>
            </div>
            <div class="deliverable-body">
              <h3>${d.name || "Untitled deliverable"}</h3>
              <div class="deliverable-meta">
                <span>${BXCore.formatDate(d.updatedAt || d.createdAt) || "Updated recently"}</span>
                <span>${statusValue.replace("-", " ")}</span>
              </div>
              <div class="deliverable-actions">
                <button class="btn-secondary" type="button" ${hasLinks ? "" : "disabled"}>
                  ${hasLinks ? "View links" : "Link missing"}
                </button>
              </div>
            </div>
          `;
          filesGrid.appendChild(card);
        });
      }
    }
    setActiveTab("overview");

    tabsEl.querySelectorAll("[data-tab]").forEach((btn) => {
      btn.addEventListener("click", () => {
        setActiveTab(btn.dataset.tab);
      });
    });
  } else {
    headerEl.innerHTML = "";
    tabsEl.innerHTML = "";
    if (overviewSection) overviewSection.style.display = "none";
    if (filesSection) filesSection.style.display = "none";
  }

  const openFilesLinksModal = (card) => {
    if (!filesLinksModal || !filesLinksList) return;
    const title = card.dataset.title || "Deliverable links";
    const subtitle = card.dataset.subtitle || "";
    if (filesLinksTitle) filesLinksTitle.textContent = title;
    if (filesLinksSubtitle) filesLinksSubtitle.textContent = subtitle;
    filesLinksList.innerHTML = "";

    const linkDefs = [
      { key: "deliveryLink", label: "Delivery link" },
      { key: "downloadLink", label: "Download link" },
      { key: "previewLink", label: "Preview link" },
      { key: "driveLink", label: "Drive link" },
    ];

    const links = linkDefs
      .map((def) => ({ label: def.label, url: card.dataset[def.key] || "" }))
      .filter((item) => item.url);

    if (!links.length) {
      filesLinksList.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon"><i class="fas fa-link"></i></div>
          <div>
            <h3>No links available</h3>
            <p>Links will appear here once they are added.</p>
          </div>
        </div>
      `;
    } else {
      links.forEach((item) => {
        const linkEl = document.createElement("a");
        linkEl.className = "modal-link";
        linkEl.href = item.url;
        linkEl.target = "_blank";
        linkEl.rel = "noopener";
        linkEl.innerHTML = `<i class="fas fa-link"></i> ${item.label}`;
        filesLinksList.appendChild(linkEl);
      });
    }

    filesLinksModal.classList.add("is-open");
    filesLinksModal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  };

  const closeFilesLinksModal = () => {
    if (!filesLinksModal) return;
    filesLinksModal.classList.remove("is-open");
    filesLinksModal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
  };

  if (filesLinksModal) {
    filesLinksModal.addEventListener("click", (e) => {
      if (e.target.closest("[data-modal-close]")) {
        closeFilesLinksModal();
      }
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && filesLinksModal?.classList.contains("is-open")) {
      closeFilesLinksModal();
    }
  });

  if (filesGrid) {
    filesGrid.addEventListener("click", (e) => {
      const card = e.target.closest(".deliverable-card");
      if (!card) return;
      const hasLinks =
        card.dataset.deliveryLink ||
        card.dataset.downloadLink ||
        card.dataset.previewLink ||
        card.dataset.driveLink;
      if (!hasLinks) return;
      openFilesLinksModal(card);
    });
  }

  if (!tasks.length) {
    wrapper.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon"><i class="fas fa-list-check"></i></div>
        <div>
          <h3>No tasks available yet</h3>
          <p>Your BX Media team will add tasks as soon as production begins.</p>
          <p class="empty-hint">Next step: check back after the next update.</p>
        </div>
      </div>
    `;
    return;
  }

  const tasksToRender = selectedProject
    ? tasks.filter((t) => t.projectId === selectedProject.projectId)
    : tasks.slice();
  const assigneeFilter =
    assigneeFilterSelect && assigneeFilterSelect.value !== "all"
      ? assigneeFilterSelect.value
      : null;
  const filteredTasks = assigneeFilter
    ? tasksToRender.filter((t) => (t.assignee || "bx-media") === assigneeFilter)
    : tasksToRender;

  const getProjectNameForTask = (task) => {
    const project = projects.find((p) => p.projectId === task.projectId);
    return project?.name || project?.projectId || "";
  };

  wrapper.innerHTML = "";
  const list = document.createElement("div");
  list.className = "tasks-group-list";

  const statusGroups = [
    {
      key: "in-progress",
      label: "In Progress",
      icon: "fas fa-bolt",
      emptyTitle: "No active tasks",
      emptyHint: "Next step: we will notify you when work begins.",
    },
    {
      key: "completed",
      label: "Completed",
      icon: "fas fa-check",
      emptyTitle: "No completed tasks yet",
      emptyHint: "Next step: completed work will appear after delivery.",
    },
  ];

  statusGroups.forEach((group) => {
    const useOrder = Boolean(selectedProjectId);
    const groupTasks = filteredTasks
      .filter((t) => {
        const status = t.status || "not-started";
        if (group.key === "in-progress") {
          return status !== "completed";
        }
        return status === group.key;
      })
      .sort((a, b) => {
        if (useOrder) {
          const aOrder = Number.isFinite(Number(a.taskOrder)) ? Number(a.taskOrder) : Number.MAX_SAFE_INTEGER;
          const bOrder = Number.isFinite(Number(b.taskOrder)) ? Number(b.taskOrder) : Number.MAX_SAFE_INTEGER;
          if (aOrder !== bOrder) return aOrder - bOrder;
        } else {
          const projectA = getProjectNameForTask(a).toLowerCase();
          const projectB = getProjectNameForTask(b).toLowerCase();
          const projectDiff = projectA.localeCompare(projectB);
          if (projectDiff !== 0) return projectDiff;
          const aOrder = Number.isFinite(Number(a.taskOrder)) ? Number(a.taskOrder) : Number.MAX_SAFE_INTEGER;
          const bOrder = Number.isFinite(Number(b.taskOrder)) ? Number(b.taskOrder) : Number.MAX_SAFE_INTEGER;
          if (aOrder !== bOrder) return aOrder - bOrder;
        }
        return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
      });

    const section = document.createElement("section");
    section.className = "client-task-group";
    section.innerHTML = `
      <header class="client-task-group-header">
        <h3>${group.label}</h3>
        <span class="badge ${group.key}">${groupTasks.length}</span>
      </header>
    `;

    if (!groupTasks.length) {
      const empty = document.createElement("div");
      empty.className = "empty-state";
      empty.innerHTML = `
        <div class="empty-icon"><i class="${group.icon}"></i></div>
        <div>
          <h3>${group.emptyTitle}</h3>
          <p>We'll surface updates here as soon as they are ready.</p>
          <p class="empty-hint">${group.emptyHint}</p>
        </div>
      `;
      section.appendChild(empty);
    } else {
      groupTasks.forEach((task) => {
        const item = document.createElement("div");
        item.className = "client-task-card";
        const dueLabel = BXCore.formatDate(task.dueDate) || "No due date";
        const assigneeLabel = task.assignee === "client" ? "Client" : "BX Media";
        const description = task.description || "";
        item.innerHTML = `
          <div>
            <strong>${task.title || "Task"}</strong>
            ${description ? `<div class="client-task-desc">${description}</div>` : ""}
            <div class="client-task-meta">Due: ${dueLabel} | Assignee: ${assigneeLabel}</div>
          </div>
          <span class="badge ${task.status || "not-started"}">
            ${(task.status || "not-started").replace("-", " ")}
          </span>
        `;
        section.appendChild(item);
      });
    }

    list.appendChild(section);
  });

  wrapper.appendChild(list);

  populateProjectFilter();
  if (projectFilterSelect) {
    projectFilterSelect.addEventListener("change", () => {
      const nextId = projectFilterSelect.value;
      if (nextId === "all") {
        window.location.search = "";
      } else {
        const next = new URLSearchParams(window.location.search);
        next.set("projectId", nextId);
        window.location.search = next.toString();
      }
    });
  }

  if (assigneeFilterSelect) {
    assigneeFilterSelect.addEventListener("change", () => {
      if (document.visibilityState !== "visible") return;
      window.location.reload();
    });
  }

  setInterval(() => {
    if (document.visibilityState !== "visible") return;
    window.location.reload();
  }, 20000);
});
</script>

</body>
</html>
